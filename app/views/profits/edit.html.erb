<% title "Funabiki Online - 計算表作成" %>

<div class="container-flex profit_container">
	<div class="row align-middle m-3">
		<div class="col">
			<div class="btn-group float-right" role="group" aria-label="Basic">
				<%= link_to '前へ', profits_path, class: 'btn btn-secondary' %>
			</div>
		<hr/>
		<div class="notice_container mt-2">
			<div class="alert alert-success" id="autosave_notice">
				自動保存されました。
			</div>
		</div>
	<div id="profit_form" class="profit_form">
	

		<div class="row">

			<div class="col-lg-3 col-md-12">
				<%= simple_form_for @profit, :remote => true do |form| %>
				<% if @profit.errors.any? %>
				<div class="container small">
					<div class="alert alert-warning alert-dismissible">
						<a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
						<h5 class="text-danger">
							<%= pluralize(@profit.errors.count, "error") %> prohibited this profit from being saved:
						</h5>
						<ul>
							<% @profit.errors.full_messages.each do |msg| %>
							<li><%= msg %></li>
							<% end %>
						</ul>
					</div>
				</div>
				<% end %>

				<div class="row mb-2">
					<div class="col-sm-12">
						<div class="card mb-2">
							<span class="card-header">
								<b><%= form.label :sales_date, '計算日' %></b>
							</span>
							<div class="card-body">
								<div class="input-group sales_date">
									<div class="input-group-prepend lg-prepend-fix">
										<div class="input-group-text">
											<%= icon("calendar-event") %>
										</div>
									</div>
									<%= form.text_field :sales_date, 'data-behaviour' => 'datepicker', class: "form-control form-control-lg datepicker mb-2" %>
								</div>
							</div>
						</div>
					</div>
					<% if @profit.check_completion[0] != 0 %>
						<div class="col-sm-12">
							<div class="card mt-2">
								<a class="card-header" data-toggle="collapse" href="#unfinished" role="button" aria-expanded="false" aria-controls="unfinished"><b>入力されていない市場</b></a>
								<span class="card-body small collapse" id="unfinished">
									<% @profit.check_completion.each do |market_id, unfinished_products| %>
										<% if market_id != 0 %>
											<% market = Market.find(market_id) %>
											<a class="btn btn-sm <%= profit_nav_font_color(market.color).to_s %>" style="background-color: <%= market.color %>;">
												<%= market.nick %>
											</a>
											<br>
												<% unfinished_products.each do |product_id| %>
													→<%= Product.find(product_id).namae %><br>
												<% end %>
												<br>
											<% end %>
									<% end %>
								</span>
							</div>
						</div>
					<% end %>
					<div class="col-sm-12">
						<div class="card mt-2 text-center">
							<span class="card-header">
								<% form.hidden_field :id, value: @profit.id %>
								<%= form.submit '計算', :class => 'btn btn-secondary w-100' %>
							</span>
						</div>
					</div>
				</div>
				<% end %>
			</div>

			<div class="col-lg-9 col-md-12">
				<nav>
					<div class="nav nav-pills d-flex m-3" id="market-pills" role="tablist">
						<% @markets.each_with_index do |market, i| %>
							<%= link_to market.nick, fetch_market_path(:market_id => market.id, profit: @profit), :remote => 'true', :id => 'navBtn' + market.id.to_s, :class => 'd-flex flex-grow-1 align-content-center text-center nav-item nav-link ' + active(i).to_s + profit_nav_font_color(market.color).to_s, "data-toggle" => "pill", "role" => "tab", "style" => "background-color: " + market.color.to_s + ";" %>
						<% end %>
					</div>
				</nav>

				<div class="tab-content" id="nav-tabContent">
					<div class="tab-pane fade show active" id="nav-partial" role="tabpanel">
						<div id="partial">
							<%= render :partial => 'edit_partial_form', locals: { market: @market, profit: @profit }, :remote => 'true', cached: true %>
						</div>
					</div>
				</div>
			</div>

		</div>

	</div>

	<hr/>

	</div>
	</div>
</div>